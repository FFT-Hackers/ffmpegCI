# .appveyor.yml

# Build version
version: '4.3.0.{build}'

# Use the latest available toolchain
image: Visual Studio 2019

# fetch repository as zip archive
shallow_clone: true

# PRs do not increment the build number
pull_requests:
  do_not_increment_build_number: true

# Default environment variables
environment:
  _IS_BUILD_CANARY: false
  _RELEASE_NAME: ffmpeg
  # FFMpeg features to be built
  _FFMPEG_FEATURES: gpl,x264,vpx,avresample
  _FFMPEG_TRIPLETNAME: x86-windows-static
  # vcpkg envs
  _VCPKG_PATH: C:\Tools\vcpkg
  # vc vars
  VCVARSALLPATH: C:\"Program Files (x86)\Microsoft Visual Studio"\2019\Community\VC\Auxiliary\Build\vcvarsall.bat
  VCVARSALL: x86

# Prepare Cpp environment
before_build:
  - ps: |
      $env:_FFMPEG_REF = $env:APPVEYOR_BUILD_VERSION.Substring(0,$env:APPVEYOR_BUILD_VERSION.LastIndexOf('.'))
      if ($env:APPVEYOR_REPO_TAG -eq "true" -and $env:APPVEYOR_REPO_TAG_NAME) {
        $env:APPVEYOR_BUILD_VERSION = $env:APPVEYOR_BUILD_VERSION.Substring(0,$env:APPVEYOR_BUILD_VERSION.LastIndexOf('.')) + ".0"
        $env:_RELEASE_NAME = $env:_RELEASE_NAME + "-v" + $env:APPVEYOR_BUILD_VERSION
      } else {
        $env:_RELEASE_NAME = $env:_RELEASE_NAME + "-Canary"
        $env:APPVEYOR_REPO_TAG_NAME = "canary"
        $env:_IS_BUILD_CANARY = "true"
      }
  - cmd: |
      call %VCVARSALLPATH% %VCVARSALL%
      cp -rf patch/* %_VCPKG_PATH%/
  - ps: |
      $newFile = New-Item -ItemType "file" -Path "C:\initialized-msys2_64.stamp"

build_script:
  - cmd: |
      %_VCPKG_PATH%\vcpkg install "ffmpeg[%_FFMPEG_FEATURES%]:%_FFMPEG_TRIPLETNAME%" --recurse
      %_VCPKG_PATH%\vcpkg export "ffmpeg[%_FFMPEG_FEATURES%]:%_FFMPEG_TRIPLETNAME%" --output=%_RELEASE_NAME% --zip
      mv %_VCPKG_PATH%\%_RELEASE_NAME%.zip .

test: off

artifacts:
  - path: ${_RELEASE_NAME}.zip
    name: ${_RELEASE_NAME}

# Create a GitHub release for every tag
deploy:
  # Deploy only when new tags are pushed
  - provider: GitHub
    tag: ${appveyor_repo_tag_name}
    release: ${_RELEASE_NAME}
    artifact: ${_RELEASE_NAME}
    auth_token: ${_GH_DEPLOYMENT_TOKEN}
    on:
      _IS_BUILD_CANARY: false
  # Deploy on each commit
  - provider: GitHub
    tag: ${appveyor_repo_tag_name}
    release: ${_RELEASE_NAME} v${appveyor_build_version}
    artifact: ${_RELEASE_NAME}
    prerelease: true
    force_update: true
    auth_token: ${_GH_DEPLOYMENT_TOKEN}
    on:
      _IS_BUILD_CANARY: true
    description: |
      This is a canary build. Please be aware it may be prone to crashing and is NOT tested by anyone. Use this build AT YOUR OWN RISK!
